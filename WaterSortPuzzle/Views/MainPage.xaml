<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:WaterSortPuzzle.ViewModels"
             xmlns:behaviors="clr-namespace:WaterSortPuzzle.Behaviors"
             xmlns:enums="clr-namespace:WaterSortPuzzle.Enums"
             xmlns:models="clr-namespace:WaterSortPuzzle.Models"
             xmlns:controls="clr-namespace:WaterSortPuzzle.Views.Controls"
             xmlns:converters="clr-namespace:WaterSortPuzzle.Converters"
             xmlns:fontAwesome="clr-namespace:FontAwesome"
             xmlns:fonts="clr-namespace:FontAwesome"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:views="clr-namespace:WaterSortPuzzle.Views"
             xmlns:bl="clr-namespace:Microsoft.Maui.Controls;assembly=Microsoft.Maui.Controls"
             x:Class="WaterSortPuzzle.Views.MainPage"
             Shell.NavBarIsVisible="False"
             x:DataType="viewModels:MainVM">
    <ContentPage.Resources>
        <converters:MultiValueConverter x:Key="MultiValueConv"/>
    </ContentPage.Resources>

    <Grid x:Name="RootLayout">
        <Image
            Source="blue_blobs_lowerres.jpg"
            Aspect="AspectFill"
            HorizontalOptions="Start"
            ZIndex="-10"
            />

        <Grid RowDefinitions="auto,*,auto" VerticalOptions="Fill">
            <!--#region Top section -->


            <Grid Padding="0,0,0,15">
                <Grid.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#7B000000" Offset="0"/>
                        <GradientStop Color="#7B000000" Offset="0.8"/>
                        <GradientStop Color="Transparent" Offset="1"/>
                    </LinearGradientBrush>
                </Grid.Background>

                <StackLayout Orientation="Vertical" IsVisible="{Binding AppPreferences.LevelingMode}" HorizontalOptions="Center">
                    <Label 
                        Text="{Binding Leveling.Level, StringFormat='Level {0}'}"
                        TextColor="White"
                        FontSize="35"
                        VerticalTextAlignment="Center"
                        Margin="0,10,0,0"
                        >
                        <Label.Shadow>
                            <Shadow Brush="Black"
                            Offset="1,1"
                            Radius="10"
                            Opacity="1" />
                        </Label.Shadow>
                    </Label>
                    <Label
                        Text="{Binding Leveling.Score, StringFormat='Score: {0}'}"
                        TextColor="White"
                        HorizontalTextAlignment="Center"
                        />
                </StackLayout>
                <StackLayout Orientation="Vertical" Margin="5">
                    <Grid ColumnDefinitions="*,*,*" HorizontalOptions="Fill" IsVisible="{Binding AppPreferences.LevelingMode}">
                        <ImageButton
                            Source="button_options.png"
                            Style="{StaticResource NavigationImageButton}"
                            Command="{Binding NavigationMenuPopupCommand}"
                            CommandParameter="{x:Static enums:PopupParams.QuickOptions}"
                            Grid.Column="0"/>

                        <ImageButton
                            Source="button_restart.png"
                            Style="{StaticResource NavigationImageButton}"
                            Command="{Binding NavigationMenuPopupCommand}"
                            CommandParameter="{x:Static enums:PopupParams.RestartLevel}"
                            Grid.Column="2">
                            <ImageButton.Behaviors>
                                
                            </ImageButton.Behaviors>
                        </ImageButton>
                    </Grid>

                    <Grid ColumnDefinitions="*,*,*" HorizontalOptions="Fill" IsVisible="{Binding AppPreferences.SingleLevelMode}">
                        <ImageButton
                            Source="button_options.png"
                            Style="{StaticResource NavigationImageButton}"
                            Command="{Binding NavigationMenuPopupCommand}"
                            CommandParameter="{x:Static enums:PopupParams.QuickOptions}"
                            Grid.Column="0"/>
                        <ImageButton
                            Source="button_restart.png"
                            Style="{StaticResource NavigationImageButton}"
                            Command="{Binding NavigationMenuPopupCommand}"
                            CommandParameter="{x:Static enums:PopupParams.RestartLevel}"
                            Grid.Column="2">
                            <ImageButton.Behaviors>
                                
                            </ImageButton.Behaviors>
                        </ImageButton>
                        <ImageButton
                            Source="button_next_level.png"
                            Style="{StaticResource NavigationImageButton}"
                            Command="{Binding NavigationMenuPopupCommand}"
                            CommandParameter="{x:Static enums:PopupParams.NewLevel}"
                            Grid.Column="1">
                            <ImageButton.Behaviors>
                                
                            </ImageButton.Behaviors>
                        </ImageButton>
                    </Grid>

                    <!--<BoxView Style="{StaticResource Separator}" Margin="0,4,0,0"/>-->
                </StackLayout>
            </Grid>


            <!--#endregion-->

            <!--#region // Mid section // -->

            <!-- // Grid for Tubes // -->

            <Grid Grid.Row="1" Margin="{Binding MarginForFlasksGrid}">
                <AbsoluteLayout bl:BindableLayout.ItemsSource="{Binding TubesItemsSource}"
                                VerticalOptions="Center" HorizontalOptions="Center">
                    <bl:BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:TubeData">
                            <!--AbsoluteLayout.LayoutBounds="0, 10, 46, 194"-->
                            <Grid
                                AbsoluteLayout.LayoutBounds="{Binding Coordinates}"
                                Style="{StaticResource TubeGrid}" Padding="3,20,3,0" x:Name="RootGrid" IsVisible="{Binding IsVisible}"
                                >
                                <Grid.Behaviors>
                                    <behaviors:TranslateOnBoolChangedBehavior
                                        Trigger="{Binding IsRaised}" YTo="-20" AnimationType="{x:Static enums:AnimationType.RaiseNLower}"
                                        AdditionalAnimation="{Binding TriggerReposition}"
                                        />
                                    <behaviors:TranslateOnBoolChangedBehavior
                                        Trigger="{Binding TriggerReposition, Mode=TwoWay}"
                                        XTo="{Binding TranslateX}" YTo="{Binding TranslateY}"
                                        ActualWidth="{Binding ActualWidth}"
                                        ActualHeight="{Binding ActualHeight}"
                                        AnimationType="{x:Static enums:AnimationType.RepositionTube}"
                                        DelayedAction="{Binding TargetTube.DisplayPourEffect, Mode=TwoWay}"
                                        TubeData="{Binding .}"
                                         /> <!--DelayedAction="{Binding DisplayPourEffect, Mode=TwoWay}"-->
                                </Grid.Behaviors>
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer NumberOfTapsRequired="1"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:MainVM}}, x:DataType=viewModels:MainVM, Path=TubeButtonClickCommand}">
                                        <TapGestureRecognizer.CommandParameter>
                                            <MultiBinding Converter="{StaticResource MultiValueConv}">
                                                <MultiBinding.Bindings>
                                                    <Binding/>
                                                    <Binding Source="{RelativeSource Mode=Self}"/>
                                                    <Binding Source="{RelativeSource AncestorType={x:Type Grid}}" />
                                                </MultiBinding.Bindings>
                                            </MultiBinding>
                                        </TapGestureRecognizer.CommandParameter>
                                    </TapGestureRecognizer>
                                </Grid.GestureRecognizers>

                                <!--IsVisible="{Binding TriggerRippleEffect}"-->
                                <Border Style="{StaticResource TubeBorder}" Margin="0,4,0,0" Background="LightBlue" InputTransparent="True"
                                    Stroke="LightBlue" StrokeThickness="1" StyleId="{x:Static models:Constants.InnerBorderElementName}"
                                    StrokeShape="RoundRectangle 0,0,28,28" >
                                    <Border.Shadow>
                                        <Shadow Brush="Black"
                                            Offset="1,1"
                                            Radius="10"
                                            Opacity="0.8" />
                                    </Border.Shadow>

                                    <Grid IsClippedToBounds="True">
                                        <Grid
                                            RowDefinitions="*,*,*,*" StyleId="{x:Static models:Constants.RippleElementName}"
                                            Margin="0,21,0,0"
                                            VerticalOptions="Fill"
                                            WidthRequest="200"
                                            HorizontalOptions="Center"
                                            IsClippedToBounds="True"
                                            ><!--InputTransparent="True"-->
                                            <BoxView Grid.Row="0" Background="{Binding Layers[3].Brush}" />
                                            <BoxView Grid.Row="1" Background="{Binding Layers[2].Brush}" />
                                            <BoxView Grid.Row="2" Background="{Binding Layers[1].Brush}" />
                                            <BoxView Grid.Row="3" Background="{Binding Layers[0].Brush}" />

                                            <AbsoluteLayout
                                                Grid.Row="{Binding RippleGridRow}"
                                                Grid.RowSpan="{Binding RippleGridRowSpan}"
                                                HorizontalOptions="Center"
                                                VerticalOptions="Fill"
                                                IsClippedToBounds="True"
                                                BackgroundColor="LightBlue"
                                                IsVisible="False"
                                                >
                                                <AbsoluteLayout.Behaviors>
                                                    <behaviors:TranslateOnBoolChangedBehavior
                                                        Trigger="{Binding TriggerRippleEffect, Mode=TwoWay}"
                                                        AnimationType="{x:Static enums:AnimationType.RippleEffect}"
                                                        TubeData="{Binding .}"
                                                        />
                                                    <!--DelayedAction="{Binding DisplayPourEffect, Mode=TwoWay}"-->
                                                </AbsoluteLayout.Behaviors>
                                                <Grid
                                                    AbsoluteLayout.LayoutBounds="0.5,1"
                                                    AbsoluteLayout.LayoutFlags="PositionProportional"
                                                    HeightRequest="30"
                                                    StyleId="{x:Static models:Constants.InnerGridElementName}"
                                                    BackgroundColor="{Binding PourBackgroundColor}"
                                                    >
                                                    <!--<BoxView
                                                        BackgroundColor="{Binding PourBackgroundColor}" HeightRequest="30" WidthRequest="129" Margin="0" />-->
                                                    <Image
                                                        
                                                        AbsoluteLayout.LayoutBounds="0,1"
                                                        AbsoluteLayout.LayoutFlags="PositionProportional"
                                                        Source="tube_surface_ripple_300.gif"
                                                        Aspect="Center"
                                                        IsAnimationPlaying="True"
                                                        HorizontalOptions="Center"
                                                        VerticalOptions="Start"
                                                        x:Name="MyImage"
                                                        />
                                                </Grid>
                                                <!--TranslationY="{x:Static models:Constants.RippleEffectOffset}"-->
                                            </AbsoluteLayout>
                                        </Grid>

                                        <!--flask gleam-->
                                        <Grid RowDefinitions="84*,16*">
                                            <BoxView BackgroundColor="Transparent">
                                                <BoxView.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="Transparent" Offset="0"/>
                                                        <GradientStop Color="Transparent" Offset="0.1"/>
                                                        <GradientStop Color="#4FFFFFFF" Offset="0.2"/>
                                                        <GradientStop Color="Transparent" Offset="0.3"/>
                                                    </LinearGradientBrush>
                                                </BoxView.Background>
                                            </BoxView>
                                            
                                            <BoxView BackgroundColor="Transparent" Grid.Row="1">
                                                <BoxView.Background>
                                                    <RadialGradientBrush Center="0.2,0" Radius="0.5">
                                                        <GradientStop Color="#3AFFFFFF" Offset="0.0"/>
                                                        <GradientStop Color="Transparent" Offset="0.2"/>
                                                    </RadialGradientBrush>
                                                </BoxView.Background>
                                            </BoxView>
                                        </Grid>

                                        <!--<BoxView
                                            BackgroundColor="Transparent">
                                            <BoxView.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                    <GradientStop Color="LightBlue" Offset="0"/>
                                                    <GradientStop Color="#00000000" Offset="0.1"/>
                                                    <GradientStop Color="#00000000" Offset="0.9"/>
                                                    <GradientStop Color="LightBlue" Offset="1"/>
                                                </LinearGradientBrush>
                                            </BoxView.Background>
                                        </BoxView>
                                        <BoxView BackgroundColor="Red"
                                                 VerticalOptions="End" HeightRequest="23" WidthRequest="44">--><!--This should be eventuall using StaticResource TubeGrid to dynamically change height, maybe half of that other value--><!--
                                            <BoxView.Background>
                                                <RadialGradientBrush Center="0.5,0.0" Radius="0.5">
                                                    <GradientStop Color="#00000000" Offset="0.0"/>
                                                    <GradientStop Color="#00FF0000" Offset="0.9"/>
                                                    <GradientStop Color="LightBlue" Offset="1"/>
                                                </RadialGradientBrush>
                                            </BoxView.Background>
                                        </BoxView>-->
                                    </Grid>
                                </Border>

                                <!--flask neck:-->
                                <Border Margin="0,4,0,0" Style="{StaticResource FlaskNeck}" HeightRequest="8" VerticalOptions="Start" HorizontalOptions="Center" WidthRequest="48"
                                    BackgroundColor="#A7D1DF" StrokeShape="RoundRectangle 0,0,5,5" StrokeThickness="0">
                                    <!--flask gleam:-->
                                    <BoxView BackgroundColor="Transparent">
                                        <BoxView.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="Transparent" Offset="0"/>
                                                <GradientStop Color="Transparent" Offset="0.1"/>
                                                <GradientStop Color="#4FFFFFFF" Offset="0.20"/>
                                                <GradientStop Color="Transparent" Offset="0.35"/>
                                            </LinearGradientBrush>
                                        </BoxView.Background>
                                    </BoxView>
                                </Border>

                                <BoxView
                                    IsVisible="{Binding DisplayPourEffect, Mode=TwoWay}"
                                    WidthRequest="6"
                                    HeightRequest="{Binding PourEffectHeight}"
                                    TranslationY="-52"
                                    BackgroundColor="{Binding PourBackgroundColor}"
                                    VerticalOptions="Start"
                                    />
                            </Grid>
                        </DataTemplate>
                    </bl:BindableLayout.ItemTemplate>
                </AbsoluteLayout>

                <Border
                    IsVisible="{Binding GrayOutMiddleOfTheScreen}"
                    StrokeThickness="0"
                    BackgroundColor="#70000000">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="#00FF0000" Offset="0"/>
                            <GradientStop Color="#80000000" Offset="0.1"/>
                            <GradientStop Color="#80000000" Offset="0.9"/>
                            <GradientStop Color="#00FF0000" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>

                <!-- // AutoSolve box // -->
                <HorizontalStackLayout VerticalOptions="End" IsVisible="{Binding AutoSolve.Started}" HorizontalOptions="Start" Margin="5,0" >
                    <Label
                        Text="{Binding AutoSolve.Iterations}"
                        HeightRequest="40"
                        WidthRequest="40"
                        HorizontalTextAlignment="Center"
                        VerticalTextAlignment="Center"
                        Background="White"
                        TextColor="Black"/>
                    <Label
                        Margin="5,0,0,0"
                        IsVisible="{Binding AutoSolve.NoSolutionFound}"
                        TextColor="White"
                        VerticalOptions="Center"
                        Text="No solution for this state of the game">
                        <Label.Shadow>
                            <Shadow Brush="Black"
                                Offset="1,1"
                                Radius="10"
                                Opacity="1" />
                        </Label.Shadow>
                    </Label>
                </HorizontalStackLayout>

                <!--<Grid VerticalOptions="Start" HorizontalOptions="Center" x:Name="GridForTubes">
                    <usercontrols:TubeControl TubeItem="{Binding Tubes[0]}"/>
                </Grid>-->
                <!--<Button Text="Get Solution" Style="{StaticResource NavigationButtonAdvancedSettings}" Command="{Binding AutoSolve.StartCommand}" IsVisible="{Binding AppPreferences.AdvancedOptionsVisible}" />-->


                <Border Stroke="White" StrokeThickness="1" VerticalOptions="End" Margin="0,0,0,5" HorizontalOptions="End" IsVisible="{Binding AutoSolve.InProgress}">
                    <Label Text="Game locked while automatic solution is engaged." TextColor="White" Margin="1" FontSize="9" />
                </Border>
            </Grid>
            
            <!--#endregion-->
            
            <!--#region Bottom section -->
            
            <!-- // Bottom Bar // -->

            <StackLayout Orientation="Vertical" Grid.Row="2" Margin="0">
                <!--<BoxView Style="{StaticResource Separator}" Margin="0,0,0,4"/>-->

                <Grid Padding="0,25,0,0">
                    <Grid.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Color="Transparent" Offset="0"/>
                            <GradientStop Color="#7B000000" Offset="0.2"/>
                            <GradientStop Color="#7B000000" Offset="1"/>
                        </LinearGradientBrush>
                    </Grid.Background>
                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="25">
                        <!--<Button
                            Command="{Binding TestMethodCommand}"
                            Text="DEBUG"
                            Grid.Column="0">
                        </Button>-->
                        <!--<Button
                            IsVisible="{Binding AutoSolve.Solved}"
                            ImageSource="button_next.png"
                            Style="{StaticResource NavigationButton}"
                            Command="{Binding StepThroughCommand}"
                            Text="{Binding NextStepButtonText}"
                            Grid.Column="0">
                            <Button.Behaviors>
                                <models:CoachMarkBehavior Id="AutoSolveNextStepButton" />
                            </Button.Behaviors>
                        </Button>-->
                        <Border Style="{StaticResource NavigationTapEnabledLayout}" IsVisible="{Binding AutoSolve.Solved}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding StepThroughCommand}" />
                            </Border.GestureRecognizers>
                            <Border.Behaviors>
                                
                            </Border.Behaviors>
                            <Grid Style="{StaticResource NavigationTapEnabledLayout_Grid}">
                                <Border Style="{StaticResource NavigationTapEnabledLayout_Border}">
                                    <Border.Triggers>
                                        <DataTrigger
                                            TargetType="Border"
                                            Binding="{Binding AutoSolve.Solved}"
                                            Value="False">
                                            <Setter Property="BackgroundColor" Value="#ADADAD" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Label Style="{StaticResource NavigationTapEnabledLayout_Label}" Text="{Binding NextStepButtonText}" />
                                </Border>
                                <Image Source="button_next.png" VerticalOptions="Start" Margin="0,4,0,0" />
                            </Grid>
                        </Border>
                        <Button
                            ImageSource="{Binding AddExtraTubeImage}"
                            Style="{StaticResource NavigationButton}"
                            Command="{Binding AddExtraTubeCommand}"
                            Text=" "
                            Grid.Column="1">
                            <Button.Behaviors>
                                
                            </Button.Behaviors>
                        </Button>
                        <!--<Button
                            ImageSource="{Binding StepBackImage}"
                            Style="{StaticResource NavigationButton}"
                            Command="{Binding StepBackCommand}"
                            Text="{Binding StepBackButtonText}"
                            Grid.Column="2">
                            <Button.Behaviors>
                                <models:CoachMarkBehavior Id="StepBackButton" ReportBounds="{Binding Source={x:Reference HelpPopupRoot}, Path=BindingContext.CoachMarkManager.OnBoundsReported}" />
                            </Button.Behaviors>
                        </Button>-->
                        <Border Style="{StaticResource NavigationTapEnabledLayout}" Grid.Column="2" x:Name="StepBackButton">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding StepBackCommand}" />
                            </Border.GestureRecognizers>
                            <Border.Behaviors>
                                <behaviors:CoachMarkBehavior
                                    Text="Step Back button"
                                    Overlay="{x:Reference CoachOverlay}" />
                            </Border.Behaviors>

                            <Grid Style="{StaticResource NavigationTapEnabledLayout_Grid}">
                                <Border Style="{StaticResource NavigationTapEnabledLayout_Border}">
                                    <Border.Triggers>
                                        <DataTrigger
                                                TargetType="Border"
                                                Binding="{Binding CanStepBack}"
                                                Value="False">
                                            <Setter Property="BackgroundColor" Value="#ADADAD" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Label Style="{StaticResource NavigationTapEnabledLayout_Label}" Text="{Binding StepBackButtonText}" />
                                </Border>
                                <Image Source="{Binding StepBackImage}" VerticalOptions="Start" Margin="0,4,0,0" />
                            </Grid>
                        </Border>
                    </Grid>
                </Grid>

            </StackLayout>
            <!--#endregion-->

        </Grid>
        <!--#region CoachMarks-->
        <views:CoachMarkOverlay
                x:Name="CoachOverlay"
                IsVisible="False" />
        <!--#endregion CoachMarks-->
    </Grid>
</ContentPage>
